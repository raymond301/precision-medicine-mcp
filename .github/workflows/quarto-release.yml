name: Release Book PDF with Quarto

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Chrome for Mermaid rendering
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable
          install-dependencies: true

      - name: Set up Quarto
        uses: quarto-dev/quarto-actions/setup@v2
        with:
          version: 1.7.13

      - name: Install TinyTeX (for PDF)
        run: |
          quarto install tinytex

      - name: Verify Chrome installation
        run: |
          which google-chrome-stable || which chrome || which chromium
          google-chrome-stable --version || chrome --version || chromium --version

      - name: Render Quarto Book to PDF
        run: |
          cd docs/book
          export QUARTO_CHROME="$(which google-chrome-stable)"
          quarto render --to pdf --verbose
        env:
          QUARTO_CHROME_HEADLESS_MODE: new
          CHROME_FLAGS: --no-sandbox --disable-setuid-sandbox
          QUARTO_LOG_LEVEL: DEBUG

      - name: Rename PDF with version
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          cd docs/book/_book
          mv Building-AI-Orchestrated-Precision-Oncology-Systems.pdf \
             "precision-medicine-mcp-book-${VERSION}.pdf"
          ls -lh "precision-medicine-mcp-book-${VERSION}.pdf"

      - name: Generate release notes
        id: release_notes
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          cd docs/book/_book

          {
            echo "## ðŸ“– Building AI-Orchestrated Precision Oncology Systems"
            echo ""
            echo "**Version**: ${VERSION}"
            echo "**Date**: $(date +'%Y-%m-%d')"
            echo ""
            echo "### Book Contents"
            echo "- **18 Chapters**: Complete guide from concept to production deployment"
            echo "- **4 Appendices**: Quick reference, setup guide, dataset reference, ethics framework"
            echo "- **18 Jupyter Notebooks**: Hands-on companion exercises"
            echo "- **14 Mermaid Diagrams**: Architecture and workflow visualizations (auto-rendered by Quarto)"
            echo "- **10 Screenshots**: UI examples and dashboards"
            echo ""
            echo "### What's Included"
            echo "- âœ… All 18 chapters (Introduction through Lessons Learned)"
            echo "- âœ… Complete appendices (Quick Reference, Setup, PatientOne Dataset, Bias & Ethics)"
            echo "- âœ… Production-ready MCP server implementations"
            echo "- âœ… PatientOne synthetic dataset (100% safe to share)"
            echo "- âœ… Mermaid diagrams rendered automatically (no manual conversion needed)"
            echo ""
            echo "### Technology Stack"
            echo "- **Quarto**: Professional scientific publishing system with native Mermaid support"
            echo "- **XeLaTeX**: High-quality PDF rendering"
            echo "- **GitHub Actions**: Automated builds and releases"
            echo ""
            echo "### Book Statistics"
            PAGES=$(pdfinfo "precision-medicine-mcp-book-${VERSION}.pdf" 2>/dev/null | grep Pages | awk '{print $2}' || echo "TBD")
            SIZE=$(du -h "precision-medicine-mcp-book-${VERSION}.pdf" 2>/dev/null | cut -f1 || echo "TBD")
            echo "- **Total Pages**: ~${PAGES}"
            echo "- **PDF Size**: ${SIZE}"
            echo ""
            echo "### Quick Links"
            echo "- **GitHub Repository**: https://github.com/lynnlangit/precision-medicine-mcp"
            echo "- **Companion Notebooks**: https://github.com/lynnlangit/precision-medicine-mcp/tree/main/docs/book/companion-notebooks"
            echo "- **PatientOne Dataset**: https://github.com/lynnlangit/precision-medicine-mcp/tree/main/data/patient-data/PAT001-OVC-2025"
            echo ""
            echo "### Requirements"
            echo "To use the companion materials, you'll need:"
            echo "- Python 3.11+ (3.10 for DeepCell)"
            echo "- Google Cloud Platform account (for MCP server deployment)"
            echo "- Anthropic API key or Google AI API key"
            echo ""
            echo "### Citation"
            echo "\`\`\`"
            echo "Langit, L. (2026). Building AI-Orchestrated Precision Oncology Systems:"
            echo "A Practical Guide to MCP-Based Bioinformatics (${VERSION})."
            echo "GitHub. https://github.com/lynnlangit/precision-medicine-mcp"
            echo "\`\`\`"
            echo ""
            echo "---"
            echo ""
            echo "**License**: Book content Â© 2026 Lynn Langit. Code examples: Apache 2.0."
          } > release-notes.md

          echo "notes_file=docs/book/_book/release-notes.md" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            docs/book/_book/precision-medicine-mcp-book-${{ github.ref_name }}.pdf
          body_path: docs/book/_book/release-notes.md
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload PDF as artifact (backup)
        uses: actions/upload-artifact@v4
        with:
          name: book-pdf-${{ github.ref_name }}
          path: docs/book/_book/precision-medicine-mcp-book-${{ github.ref_name }}.pdf
          retention-days: 365
