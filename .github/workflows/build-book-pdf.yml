name: Build Book PDF

on:
  push:
    branches:
      - main
    paths:
      - 'docs/book/**/*.md'
      - 'docs/book/images/**'
      - '.github/workflows/build-book-pdf.yml'
  workflow_dispatch: # Allow manual trigger

jobs:
  build-pdf:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js for Mermaid
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Mermaid CLI
        run: |
          npm install -g @mermaid-js/mermaid-cli
          mmdc --version

      - name: Concatenate book chapters in order
        run: |
          cd docs/book

          # Create title page
          cat > book-full.md << 'EOF'
---
title: "Building AI-Orchestrated Precision Oncology Systems"
subtitle: "A Practical Guide to MCP-Based Bioinformatics"
author: "Lynn Langit"
date: "2026-02-01"
toc: true
toc-depth: 2
numbersections: true
header-includes:
  - \setcounter{chapter}{-1}
include-before:
  - \setcounter{chapter}{-1}
linkcolor: blue
urlcolor: blue
geometry: margin=1in
fontsize: 11pt
documentclass: report
---

EOF

          # Concatenate all chapters in order
          cat chapter-00-introduction.md >> book-full.md

          # Part 1: Why This Matters
          for chapter in chapter-01-the-patientone-story.md chapter-02-the-architecture-problem.md chapter-03-testing-the-hypothesis.md; do
            if [ -f "$chapter" ]; then
              cat "$chapter" >> book-full.md
              echo -e "\n\n\\newpage\n\n" >> book-full.md
            fi
          done

          # Part 2: Building the Foundation
          for chapter in chapter-04-clinical-data.md chapter-05-genomic-foundations.md chapter-06-multiomics-integration.md chapter-07-spatial-transcriptomics.md; do
            if [ -f "$chapter" ]; then
              cat "$chapter" >> book-full.md
              echo -e "\n\n\\newpage\n\n" >> book-full.md
            fi
          done

          # Part 3: Advanced Capabilities
          for chapter in chapter-08-cell-segmentation.md chapter-09-treatment-response-prediction.md chapter-10-quantum-celltype-fidelity.md chapter-11-imaging-histopathology.md; do
            if [ -f "$chapter" ]; then
              cat "$chapter" >> book-full.md
              echo -e "\n\n\\newpage\n\n" >> book-full.md
            fi
          done

          # Part 4: Deployment and Operations
          for chapter in chapter-12-cloud-deployment-gcp.md chapter-13-hospital-production-deployment.md chapter-14-operations-monitoring.md; do
            if [ -f "$chapter" ]; then
              cat "$chapter" >> book-full.md
              echo -e "\n\n\\newpage\n\n" >> book-full.md
            fi
          done

          # Part 5: Research and Education
          for chapter in chapter-15-for-researchers.md chapter-16-teaching-precision-medicine.md; do
            if [ -f "$chapter" ]; then
              cat "$chapter" >> book-full.md
              echo -e "\n\n\\newpage\n\n" >> book-full.md
            fi
          done

          # Part 6: The Future
          for chapter in chapter-17-funding-sustainability.md chapter-18-lessons-learned-whats-next.md; do
            if [ -f "$chapter" ]; then
              cat "$chapter" >> book-full.md
              echo -e "\n\n\\newpage\n\n" >> book-full.md
            fi
          done

          # Appendices - insert \appendix command to switch from numbered chapters to lettered appendices
          echo -e "\n\n\\appendix\n\n" >> book-full.md

          for appendix in appendix-a-quick-reference.md appendix-b-installation-setup.md appendix-c-patientone-dataset.md appendix-d-bias-and-ethics.md; do
            if [ -f "$appendix" ]; then
              cat "$appendix" >> book-full.md
              echo -e "\n\n\\newpage\n\n" >> book-full.md
            fi
          done

          echo "‚úÖ Created book-full.md ($(wc -l < book-full.md) lines)"

      - name: Convert Mermaid diagrams to images
        run: |
          cd docs/book
          mkdir -p mermaid-images

          echo "üîÑ Converting Mermaid diagrams..."

          # Python script to extract and convert mermaid blocks
          python3 << 'PYTHON_SCRIPT'
          import re
          import subprocess
          import os

          print("üìñ Reading book-full.md...")
          with open('book-full.md', 'r') as f:
              content = f.read()

          print(f"   File size: {len(content)} characters")

          # Find all mermaid code blocks
          pattern = r'```mermaid\n(.*?)```'
          matches = list(re.finditer(pattern, content, re.DOTALL))

          print(f"\nüîç Found {len(matches)} Mermaid diagrams")

          if len(matches) == 0:
              print("‚ö†Ô∏è  WARNING: No mermaid diagrams found in book-full.md")
              print("   Check if chapters contain ```mermaid blocks")

          converted_count = 0
          for i, match in enumerate(matches):
              mermaid_code = match.group(1)
              mmd_file = f'mermaid-images/diagram-{i}.mmd'
              png_file = f'mermaid-images/diagram-{i}.png'

              print(f"\nüìù Processing diagram {i}:")
              print(f"   Code length: {len(mermaid_code)} chars")
              print(f"   First line: {mermaid_code.split(chr(10))[0][:50]}...")

              # Write mermaid code to file
              with open(mmd_file, 'w') as f:
                  f.write(mermaid_code)
              print(f"   ‚úÖ Wrote {mmd_file}")

              # Convert to PNG using mmdc
              try:
                  result = subprocess.run([
                      'mmdc',
                      '-i', mmd_file,
                      '-o', png_file,
                      '-b', 'white',
                      '--puppeteerConfigFile', '/dev/null',
                      '--no-sandbox'
                  ], check=True, capture_output=True, text=True)

                  # Verify PNG was created
                  if os.path.exists(png_file):
                      size = os.path.getsize(png_file)
                      print(f"   ‚úÖ Created {png_file} ({size} bytes)")
                      converted_count += 1

                      # Replace mermaid block with image reference
                      old_text = match.group(0)
                      new_text = f'![Diagram {i}](mermaid-images/diagram-{i}.png)'
                      content = content.replace(old_text, new_text)
                      print(f"   ‚úÖ Replaced code block with image reference")
                  else:
                      print(f"   ‚ùå PNG file not created!")

              except subprocess.CalledProcessError as e:
                  print(f"   ‚ùå mmdc failed: {e}")
                  print(f"   stdout: {e.stdout}")
                  print(f"   stderr: {e.stderr}")

          print(f"\nüìä Conversion Summary:")
          print(f"   Total diagrams found: {len(matches)}")
          print(f"   Successfully converted: {converted_count}")
          print(f"   Failed: {len(matches) - converted_count}")

          # Write modified content
          with open('book-with-images.md', 'w') as f:
              f.write(content)

          print(f"\n‚úÖ Created book-with-images.md")

          # Verify no mermaid code blocks remain
          remaining = content.count('```mermaid')
          if remaining > 0:
              print(f"\n‚ùå ERROR: {remaining} mermaid blocks still present after conversion!")
              print("   This means the replacement failed - checking why...")
              # Show first remaining block for debugging
              first_block = content[content.find('```mermaid'):content.find('```mermaid')+100]
              print(f"   First remaining block: {first_block}...")
              exit(1)
          else:
              print(f"‚úÖ All mermaid blocks successfully replaced with images")
          PYTHON_SCRIPT

      - name: Validate Mermaid conversion
        run: |
          cd docs/book

          echo "üìä Validation Results:"
          echo "Generated PNG files:"
          ls -lh mermaid-images/*.png 2>/dev/null || echo "‚ö†Ô∏è  No PNG files found!"

          echo ""
          echo "Checking for remaining mermaid code blocks..."
          if grep -q '```mermaid' book-with-images.md; then
            echo "‚ùå FAIL: Mermaid code blocks still present in book-with-images.md"
            grep -n '```mermaid' book-with-images.md | head -5
            exit 1
          else
            echo "‚úÖ PASS: No mermaid code blocks found"
          fi

          echo ""
          echo "Checking for image references..."
          IMAGE_COUNT=$(grep -c 'mermaid-images/diagram-' book-with-images.md || echo "0")
          echo "Found $IMAGE_COUNT image references to mermaid-images/"

          if [ "$IMAGE_COUNT" -eq 0 ]; then
            echo "‚ùå FAIL: No mermaid image references found"
            exit 1
          fi

      - name: Convert Markdown to PDF
        run: |
          cd docs/book

          echo "üìù Converting book-with-images.md to PDF..."
          echo "Book source lines: $(wc -l < book-with-images.md)"

          # Mount the entire workspace so relative image paths work correctly
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -w /workspace/docs/book \
            pandoc/latex:latest \
            book-with-images.md \
            -o precision-medicine-mcp-book.pdf \
            --resource-path=.:/workspace/docs/book/images/screenshots:/workspace/docs/book/mermaid-images:/workspace/data/images \
            --pdf-engine=xelatex \
            --include-in-header=header.tex \
            --top-level-division=chapter \
            --toc \
            --toc-depth=2 \
            --number-sections \
            --highlight-style=tango \
            --variable linkcolor=blue \
            --variable urlcolor=blue \
            --variable geometry:margin=1in \
            --variable fontsize=11pt \
            --metadata date="$(date +'%Y-%m-%d')" \
            --verbose

          # Verify PDF was created
          if [ ! -f "precision-medicine-mcp-book.pdf" ]; then
            echo "‚ùå ERROR: PDF file was not created!"
            exit 1
          fi

          echo "‚úÖ PDF created successfully"
          ls -lh precision-medicine-mcp-book.pdf

          # Verify file is not empty
          PDF_SIZE=$(stat -f%z "precision-medicine-mcp-book.pdf" 2>/dev/null || stat -c%s "precision-medicine-mcp-book.pdf")
          if [ "$PDF_SIZE" -lt 1000 ]; then
            echo "‚ùå ERROR: PDF file is too small ($PDF_SIZE bytes)"
            exit 1
          fi
          echo "PDF size: $PDF_SIZE bytes"

      - name: Upload PDF as artifact
        uses: actions/upload-artifact@v4
        with:
          name: book-pdf
          path: docs/book/precision-medicine-mcp-book.pdf
          retention-days: 90

      - name: Get book statistics
        run: |
          cd docs/book
          echo "üìä Book Statistics:"
          echo "Total lines: $(wc -l < book-full.md)"
          echo "Total words: $(wc -w < book-full.md)"
          echo "PDF size: $(du -h precision-medicine-mcp-book.pdf | cut -f1)"
          echo "Chapters: $(ls -1 chapter-*.md | wc -l)"
          echo "Appendices: $(ls -1 appendix-*.md | wc -l)"
