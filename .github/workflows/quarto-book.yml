name: Build Book PDF with Quarto

on:
  push:
    branches:
      - main
    paths:
      - 'docs/book/**/*.md'
      - 'docs/book/**/*.qmd'
      - 'docs/book/images/**'
      - 'docs/book/_quarto.yml'
      - 'docs/book/header.tex'
      - '.github/workflows/quarto-book.yml'
  workflow_dispatch:

jobs:
  build-quarto-pdf:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Chrome for Mermaid rendering
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable
          install-dependencies: true

      - name: Set up Quarto
        uses: quarto-dev/quarto-actions/setup@v2
        with:
          version: 1.7.13

      - name: Install TinyTeX (for PDF)
        run: |
          quarto install tinytex

      - name: Verify Chrome installation
        run: |
          which google-chrome-stable || which chrome || which chromium
          google-chrome-stable --version || chrome --version || chromium --version

      - name: Create Chrome wrapper (adds CI-required flags)
        run: |
          cat > /usr/local/bin/chrome-wrapper <<'WRAPPER'
          #!/bin/sh
          exec google-chrome-stable \
            --no-sandbox \
            --disable-setuid-sandbox \
            --disable-dev-shm-usage \
            --disable-gpu \
            --no-first-run \
            --no-default-browser-check \
            --disable-translate \
            --disable-extensions \
            "$@"
          WRAPPER
          chmod +x /usr/local/bin/chrome-wrapper
          echo "=== Wrapper contents ===" && cat /usr/local/bin/chrome-wrapper

      - name: Render Quarto Book to PDF
        timeout-minutes: 20
        run: |
          cd docs/book
          quarto render --to pdf --verbose
        env:
          QUARTO_CHROMIUM: /usr/local/bin/chrome-wrapper
          QUARTO_CHROMIUM_HEADLESS_MODE: new
          QUARTO_LOG_LEVEL: DEBUG

      - name: Verify PDF was created
        run: |
          cd docs/book
          if [ ! -f "_book/Building-AI-Orchestrated-Precision-Oncology-Systems.pdf" ]; then
            echo "âŒ ERROR: PDF file was not created!"
            echo "Checking _book directory contents:"
            ls -la _book/
            exit 1
          fi

          PDF_SIZE=$(stat -c%s "_book/Building-AI-Orchestrated-Precision-Oncology-Systems.pdf")
          if [ "$PDF_SIZE" -lt 1000 ]; then
            echo "âŒ ERROR: PDF file is too small ($PDF_SIZE bytes)"
            exit 1
          fi

          echo "âœ… PDF created successfully"
          echo "PDF size: $PDF_SIZE bytes"
          ls -lh "_book/Building-AI-Orchestrated-Precision-Oncology-Systems.pdf"

      - name: Upload PDF as artifact
        uses: actions/upload-artifact@v4
        with:
          name: book-pdf-quarto
          path: docs/book/_book/*.pdf
          retention-days: 90

      - name: Get book statistics
        run: |
          cd docs/book
          echo "ðŸ“Š Book Statistics:"
          echo "Chapters: $(ls -1 chapter-*.md | wc -l)"
          echo "Appendices: $(ls -1 appendix-*.md | wc -l)"
          echo "PDF size: $(du -h _book/*.pdf | cut -f1)"
